import logging
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes
import g4f
from pathlib import Path
import PyPDF2
from dotenv import load_dotenv
import os
import asyncio
from reportlab.lib.pagesizes import letter
from reportlab.pdfgen import canvas
from reportlab.pdfbase import pdfmetrics
from reportlab.pdfbase.ttfonts import TTFont
from reportlab.lib.pagesizes import letter
from reportlab.pdfgen import canvas
import os
import logging


# Настройка логирования
logging.basicConfig(level=logging.INFO, format="%(asctime)s - %(levelname)s - %(message)s")
logger = logging.getLogger(__name__)

# Конфигурация
CONFIG = {
    "llm_model": "gpt-4.1-mini",  # Проверьте, поддерживается ли эта модель в g4f
    "retry_attempts": 3,
    "retry_interval": 5,
    "llm_timeout": 120,
    "max_file_size": 20 * 1024 * 1024,  # 20 MB
    "telegram_timeout": 60,  # Таймаут для запросов к Telegram API
    "max_message_length": 4000  # Максимальная длина сообщения в символах
}

class NormalControllerBot:
    def __init__(self, token: str):
        self.token = token
        self.application = Application.builder().token(self.token).read_timeout(CONFIG["telegram_timeout"]).write_timeout(CONFIG["telegram_timeout"]).build()
        self.setup_handlers()

    def setup_handlers(self):
        """Настройка обработчиков команд и сообщений."""
        self.application.add_handler(CommandHandler("start", self.start))
        self.application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, self.handle_text))
        self.application.add_handler(MessageHandler(filters.Document.ALL, self.handle_document))

    async def start(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Обработчик команды /start."""
        await update.message.reply_text(
            "Привет! Я нормоконтролёр для проверки технических заданий. "
            "Отправьте текст ТЗ или прикрепите файл (PDF, TXT). "
            "Я проверю документ на соответствие ГОСТам."
        )

    async def handle_text(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Обработчик текстовых сообщений с ТЗ."""
        text = update.message.text
        logger.info("Получен текст для анализа")
        await update.message.reply_text("Проверяю ваше техническое задание...")
        analysis = await self.analyze_tz(text)
        await self.send_analysis(update, analysis)

    async def handle_document(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Обработчик документов (PDF, TXT)."""
        document = update.message.document
        if document.file_size > CONFIG["max_file_size"]:
            await update.message.reply_text("Файл слишком большой. Максимальный размер: 20 МБ.")
            return

        file = await document.get_file()
        file_path = f"temp_{document.file_id}"
        try:
            logger.info(f"Скачивание файла: {document.file_name}")
            await file.download_to_drive(file_path)
            file_text = self.extract_text_from_file(file_path, document.mime_type)
            message_text = update.message.text or ""  # Текст сообщения, если есть
            combined_text = f"{message_text}\n\n{file_text}" if message_text else file_text
            logger.info("Текст из файла и сообщения объединён")
            await update.message.reply_text("Проверяю ваше техническое задание...")
            analysis = await self.analyze_tz(combined_text)
            await self.send_analysis(update, analysis)
        except Exception as e:
            logger.error(f"Ошибка обработки файла: {e}")
            await update.message.reply_text("Ошибка при обработке файла. Попробуйте отправить другой файл (PDF или TXT).")
        finally:
            if Path(file_path).exists():
                Path(file_path).unlink()
                logger.info(f"Временный файл {file_path} удалён")

    def extract_text_from_file(self, file_path: str, mime_type: str) -> str:
        """Извлечение текста из файла (PDF или TXT)."""
        try:
            file_ext = Path(file_path).suffix.lower()
            if mime_type == "application/pdf" or file_ext == ".pdf":
                with open(file_path, "rb") as f:
                    reader = PyPDF2.PdfReader(f)
                    text = ""
                    for page in reader.pages:
                        extracted = page.extract_text()
                        if extracted:
                            text += extracted
                    logger.info("Текст успешно извлечён из PDF")
                    return text
            elif mime_type == "text/plain" or file_ext == ".txt":
                with open(file_path, "r", encoding="utf-8") as f:
                    return f.read()
            else:
                raise ValueError("Неподдерживаемый формат файла. Используйте PDF или TXT.")
        except Exception as e:
            logger.error(f"Ошибка извлечения текста: {e}")
            raise

    async def analyze_tz(self, text: str) -> str:
        """Анализ ТЗ с использованием LLM."""
        prompt = """
        ### Промпт для нормоконтроля технического задания

        ### Роль
        Вы — нормоконтролер, специализирующийся на проверке технических заданий (ТЗ) на соответствие ГОСТам и лучшим практикам технической документации.

        ### Задача
        Проанализируйте предоставленное техническое задание, выявите ошибки, несоответствия или отклонения от требуемых стандартов и предложите исправления в формате: «Было / Замечание / Должно быть».

        ### Инструкции

        #### Проверка структуры
        Убедитесь, что проектная (конструкторская) документация на разработку аккумуляторной батареи для электроавтомобиля содержит все необходимые разделы в соответствии с ГОСТ 15.016-2016 и другими применимыми нормативными документами, включая, но не ограничиваясь:
        - ГОСТ 15.016-2016 — Система разработки и постановки продукции на производство. Проектная документация  
        - ГОСТ Р 53778-2010 — Аккумуляторные батареи. Общие технические условия  
        - ГОСТ Р 52350.11-2005 — Безопасность электрического оборудования. Требования к аккумуляторным батареям  
        - ГОСТ 12.2.007.0-75 — Электробезопасность  
        - ГОСТ 30804.4.2-2013 и ГОСТ 30804.4.3-2013 — Электромагнитная совместимость  
        - ГОСТ 12.1.044-89 — Пожарная безопасность  
        - Правила устройства электроустановок (ПУЭ)  
        - НПБ 105-03 — Нормы пожарной безопасности для аккумуляторных помещений  
        - ISO 12405 и/или IEC 62660 (при использовании международных стандартов)

        Типичные обязательные разделы документации включают:

        - Введение  
        - Наименование, основание и сроки разработки  
        - Цель разработки, наименование и обозначение изделия  
        - Технические требования к изделию  
        - Требования к сырью и материалам  
        - Требования к консервации, упаковке и маркировке  
        - Требования к учебно-тренировочным средствам (при необходимости)  
        - Специальные требования (безопасность, экология, электромагнитная совместимость)  
        - Требования к документации  
        - Этапы выполнения разработки с указанием сроков и ответственных  
        - Порядок выполнения и приемки этапов разработки  
        - Примечания и дополнительные указания  

        Проверьте наличие всех обязательных разделов, отметьте отсутствие необходимых и наличие избыточных разделов, а также соответствие содержания требованиям нормативных документов и специфике разработки АКБ для электроавтомобиля.

        #### Проверка содержания
        Проверьте, что все указанные стандарты ГОСТ и нормативные документы актуальны и правильно указаны. Убедитесь, что требования конкретны, измеримы, достижимы, релевантны и ограничены по времени (SMART). Проверьте отсутствие противоречивых или неоднозначных утверждений. Подтвердите, что все технические параметры указаны точно и полно, включая:
        - Номинальное напряжение аккумулятора и отдельных элементов (например, 12 В на элемент, 192 В на батарею из 16 элементов)
        - Емкость аккумулятора (в ампер-часах), определяющая запас энергии
        - Тип аккумуляторов (свинцово-кислотные, литий-ионные и др.) и их конструктивные особенности
        - Количество и схема соединения элементов (последовательное, параллельное подключение)
        - Ток заряда и разряда, включая максимальные пиковые токи и пусковые токи оборудования
        - Требования к качеству электропитания — стабильность напряжения и частоты, допустимые отклонения
        - Рабочая температура и условия эксплуатации аккумуляторов
        - Требования к системам контроля и безопасности — наличие систем мониторинга состояния (PCM), защита от перегрузок и коротких замыканий
        - Требования к производственной документации — чертежи, спецификации, инструкции по эксплуатации
        - Испытания и контроль качества — проверка емкости, напряжения, надежности и безопасности
        - Требования к монтажу и обслуживанию, включая условия установки и вентиляции аккумуляторных помещений
        - Сроки изготовления и поставки
        - Соответствие нормативам и стандартам (например, ГОСТ, ПУЭ, НПБ 105-03)
        1. Требования к габаритам и массе аккумуляторной батареи — размеры, вес, что важно для интеграции в конструкцию автомобиля.
        2. Условия транспортировки и хранения — температурные режимы, влажность, вибрации и удары.
        3. Энергоэффективность и коэффициент полезного действия батареи.
        4. Срок службы и циклы заряда-разряда — гарантийные показатели долговечности.
        5. Требования к системе охлаждения — тип, эффективность, способы реализации.
        6. Электромагнитная совместимость (EMC) — требования к помехозащищенности и излучению.
        7. Требования к программному обеспечению систем управления батареей (BMS) — алгоритмы управления, диагностика и обновление ПО.
        8. Требования к утилизации и экологической безопасности — материалы, возможность переработки.
        9. Требования к маркировке и идентификации элементов и сборок.
        10. Требования к документации по безопасности при аварийных ситуациях — инструкции по действиям при возгорании, утечках и т.п.
        11. Требования к совместимости с другими системами автомобиля — интерфейсы, протоколы обмена данными.
        12. Требования к испытаниям на вибрацию, удар, коррозию и другие механические воздействия.


        Проверка максимизации емкости АКБ относительно массы и актуальности технологии:

        1. Оцените используемую технологию производства аккумуляторных элементов с точки зрения удельной емкости (емкость на единицу массы, Ач/кг).  
        2. Проверьте соответствие выбранных материалов и химических составов современным достижениям в области аккумуляторных технологий (например, литий-ионные, твердотельные, литий-железо-фосфатные и др.).  
        3. Проанализируйте конструктивные решения, влияющие на снижение массы батареи при сохранении или увеличении емкости (например, использование легких корпусов, оптимизация толщины электродов, компоновка элементов).  
        4. Оцените технологию сборки и контроля качества, обеспечивающую максимальную плотность энергии и минимальные потери.  
        5. Проверьте наличие данных по испытаниям и подтверждению удельной емкости, включая сравнительный анализ с аналогичными технологиями на рынке.  
        6. Оцените актуальность технологии с учетом последних тенденций и инноваций в области аккумуляторных систем для электромобилей (например, исследования и внедрение новых материалов, технологий производства, систем управления батареей).  
        7. Проверьте соответствие технологии требованиям безопасности, долговечности и экологичности при максимальной емкости и минимальной массе.  
        8. Оцените перспективы масштабирования и серийного производства с сохранением заявленных параметров.

        Внешнии характеристики точнее устойчивость к ним
        Чек-лист проверки АКБ по температуре эксплуатации, вибрации и механическим воздействиям

        1. Температура эксплуатации
        -   Указан диапазон рабочих температур (минимальная, максимальная, оптимальная).  
        -   Диапазон температур соответствует условиям эксплуатации электроавтомобиля (климатические зоны, сезонные колебания).  
        -   Присутствуют данные по устойчивости к экстремальным температурам (низкие и высокие температуры).  
        -   Описаны системы терморегуляции и охлаждения, их эффективность и характеристики.  
        -   Приведены результаты испытаний на работоспособность и безопасность при различных температурах.  
        -   Оценено влияние температуры на емкость, срок службы, безопасность и скорость заряда/разряда.  
        -   Указаны требования к хранению и транспортировке с учетом температурных ограничений.  
        -   Соответствие температурных параметров требованиям нормативных документов (ГОСТ, ISO, IEC и др.).

         2. Вибрация
        -   Указаны параметры вибрационных испытаний (частотные диапазоны, амплитуды).  
        -   Проведены испытания на вибрационную устойчивость в соответствии с эксплуатационными условиями автомобиля.  
        -   Описаны конструктивные решения и методы защиты от вибраций.  
        -   Приведены результаты испытаний и сертификаций по вибрационной прочности.  
        -   Оценено влияние вибраций на безопасность, надежность и срок службы АКБ.  
        -   Соответствие вибрационных параметров требованиям нормативных документов (ГОСТ, ISO, IEC и др.).

         3. Механические воздействия
        -   Описаны виды механических воздействий, которым подвергается АКБ (удары, сотрясения, вибрации).  
        -   Проведены испытания на ударопрочность и механическую прочность.  
        -   Описаны конструктивные меры по повышению механической устойчивости (корпус, крепления, амортизация).  
        -   Приведены результаты испытаний и сертификаций по механической прочности.  
        -   Оценено влияние механических воздействий на безопасность, надежность и срок службы АКБ.  
        -   Соответствие механических параметров требованиям нормативных документов (ГОСТ, ISO, IEC и др.).



        #### Проверка оформления
        Убедитесь, что документ соответствует требованиям оформления:
        - Шрифт, отступы, нумерация разделов
        - Правильные подписи и ссылки на рисунки, таблицы и схемы в тексте

        #### Проверка языка и ясности
        Убедитесь, что язык документа ясен, лаконичен и подходит для целевой аудитории. Проверьте, что все технические термины определены и используются корректно.

        ### Формат ответа
        Для каждой выявленной ошибки укажите:
        - Было: [цитата или описание ошибки]
        - Замечание: [объяснение, почему это ошибка, со ссылкой на стандарт или лучшую практику]
        - Должно быть: [предложение по исправлению]

        ### Примеры
        #### Ошибка в структуре
        - Было: В документе отсутствует раздел «Требования к документации»
        - Замечание: Согласно ГОСТ 15.016-2016, ТЗ должно включать раздел о требованиях к документации, описывающий необходимые документы и их формат
        - Должно быть: Добавить раздел «Требования к документации» с указанием необходимых документов в соответствии с ГОСТ Р 15.301

        #### Ошибка в содержании (неуказанные параметры)
        - Было: Отсутствует информация о токе разряда аккумулятора
        - Замечание: Ток разряда, включая максимальные пиковые токи, обязателен для определения эксплуатационных характеристик (ГОСТ 15.016-2016, раздел технических требований)
        - Должно быть: Указать: «Ток разряда — 120 А, максимальный пиковый ток — 150 А»

        #### Ошибка в ссылках
        - Было: Указан ГОСТ 12345-2000
        - Замечание: ГОСТ 12345-2000 устарел и заменен ГОСТ 12345-2015. Необходимо использовать актуальную версию стандарта
        - Должно быть: Обновить ссылку на ГОСТ 12345-2015

        #### Ошибка в ясности
        - Было: «Аккумулятор должен быть надежным»
        - Замечание: Формулировка неконкретна, не указаны параметры надежности (например, срок службы)
        - Должно быть: «Срок службы аккумулятора не менее 2 лет при соблюдении условий эксплуатации»

        ### Дополнительные замечания
        Если конкретные детали стандарта неизвестны, опирайтесь на общие лучшие практики для технической документации. Приоритет отдавайте ясности, точности и полноте при проверке.

        ### Итоговый результат
        После анализа всего документа составьте полный список выявленных ошибок и предложенных исправлений.

        Текст ТЗ:
        {text}
        """.format(text=text)
        logger.info("Отправка запроса к LLM")
        response = await self._llm_request(prompt)
        return response

    async def _llm_request(self, prompt: str) -> str:
        """Запрос к LLM с повторными попытками."""
        model = CONFIG["llm_model"]
        for attempt in range(CONFIG["retry_attempts"] + 1):
            try:
                async with asyncio.timeout(CONFIG["llm_timeout"]):
                    response = await asyncio.to_thread(
                        g4f.ChatCompletion.create,
                        model=model,
                        messages=[{"role": "user", "content": prompt}]
                    )
                    if isinstance(response, dict):
                        return response.get("choices", [{}])[0].get("message", {}).get("content", "").strip()
                    elif isinstance(response, str):
                        return response.strip()
                    else:
                        logger.warning(f"Неожиданный тип ответа от LLM: {type(response)}")
                        return "Ответ LLM не распознан."
            except Exception as e:
                logger.exception(f"Ошибка LLM (попытка {attempt + 1}/{CONFIG['retry_attempts']}): {e}")
                if attempt < CONFIG["retry_attempts"]:
                    await asyncio.sleep(CONFIG["retry_interval"])
                else:
                    return "Не удалось получить ответ от LLM. Попробуйте позже."

    async def send_analysis(self, update: Update, analysis: str):
        """Отправка анализа: текстом или PDF в зависимости от длины."""
        if len(analysis) <= CONFIG["max_message_length"]:
            await update.message.reply_text(analysis, parse_mode="Markdown")
        else:
            pdf_path = "analysis.pdf"
            self.create_pdf(analysis, pdf_path)
            await update.message.reply_text(
                f"Ответ слишком длинный ({len(analysis)} символов), отправляю в виде файла."
            )
            with open(pdf_path, "rb") as f:
                await update.message.reply_document(f)
            os.remove(pdf_path)
            logger.info(f"PDF-файл {pdf_path} отправлен и удалён")


    logger = logging.getLogger(__name__)

    def create_pdf(self, text: str, path: str):
        """
        Создание PDF‑файла из текста с поддержкой кириллицы
        на базе шрифтов Times New Roman из Windows.
        """
        try:
            # Пути к шрифтам в Windows
            font_path = r"C:\Windows\Fonts\times.ttf"
            font_bold_path = r"C:\Windows\Fonts\timesbd.ttf"
            if not os.path.exists(font_path) or not os.path.exists(font_bold_path):
                raise FileNotFoundError("Шрифты Times New Roman не найдены по указанным путям")

            # Регистрируем шрифты
            pdfmetrics.registerFont(TTFont("TimesNewRoman", font_path))
            pdfmetrics.registerFont(TTFont("TimesNewRoman-Bold", font_bold_path))

            # Создаём canvas и устанавливаем шрифт
            c = canvas.Canvas(path, pagesize=letter)
            width, height = letter
            margin = 40
            line_height = 15
            max_width = width - 2 * margin

            # Здесь можно менять на "TimesNewRoman-Bold" для заголовков
            c.setFont("TimesNewRoman", 12)

            y = height - margin
            for raw_line in text.split("\n"):
                words = raw_line.split(" ")
                current = ""
                for word in words:
                    test_line = (current + " " + word).strip()
                    if pdfmetrics.stringWidth(test_line, "TimesNewRoman", 12) > max_width:
                        c.drawString(margin, y, current)
                        y -= line_height
                        current = word
                        if y < margin:
                            c.showPage()
                            c.setFont("TimesNewRoman", 12)
                            y = height - margin
                    else:
                        current = test_line

                c.drawString(margin, y, current)
                y -= line_height
                if y < margin:
                    c.showPage()
                    c.setFont("TimesNewRoman", 12)
                    y = height - margin

            c.save()
            logger.info(f"PDF-файл создан: {path}")

        except Exception as e:
            logger.error(f"Ошибка создания PDF: {e}", exc_info=True)
            raise


    def run(self):
        """Запуск бота."""
        try:
            logger.info("Запуск бота")
            self.application.run_polling()
        except Exception as e:
            logger.error(f"Ошибка при запуске бота: {e}")
            raise

# Загрузка токена из .env файла
load_dotenv()
token = os.getenv("TELEGRAM_BOT_TOKEN")

def main():
    if not token:
        logger.critical("Токен Telegram бота не указан в .env файле")
        raise ValueError("Токен Telegram бота не указан")
    bot = NormalControllerBot(token)
    bot.run()

if __name__ == "__main__":
    main()